<!DOCTYPE html><html><head><meta charSet="utf-8"/><title>10 underused features of modern Python [incomplete] - phiresky&#x27;s blog</title><meta name="description" content="Named tupleautomatic constructor generation etcstrong typingimmutablesame memory usage as normal tuplesdefault valuesmore safety than tuples, access params.name like objects, order does not mattercompatible API with tuplesTypingF strings Prints: for input 5.0, fn(x)=25 Similar to &quot;x is"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="alternate" type="application/rss+xml" title="RSS feed of phiresky&#x27;s blog" href="https://phiresky.github.io/blog/rss.xml"/><link rel="alternate" type="application/atom+xml" title="Atom feed of phiresky&#x27;s blog" href="https://phiresky.github.io/blog/atom.xml"/><link rel="alternate" type="application/json" title="JSON feed of phiresky&#x27;s blog" href="https://phiresky.github.io/blog/feed.json"/><style>
          body {
            font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;
          }
      </style><meta name="next-head-count" content="8"/><link rel="preload" href="/blog/_next/static/css/d142d8dffeea0e3e7918.css" as="style"/><link rel="stylesheet" href="/blog/_next/static/css/d142d8dffeea0e3e7918.css" data-n-g=""/><link rel="preload" href="/blog/_next/static/css/78a73292fe5dfabb752a.css" as="style"/><link rel="stylesheet" href="/blog/_next/static/css/78a73292fe5dfabb752a.css" data-n-p=""/><noscript data-n-css=""></noscript><link rel="preload" href="/blog/_next/static/chunks/main-a96ffcab9ac3f714966d.js" as="script"/><link rel="preload" href="/blog/_next/static/chunks/webpack-616848fc9016435d0c8a.js" as="script"/><link rel="preload" href="/blog/_next/static/chunks/framework.60867bcc68b986f6e60d.js" as="script"/><link rel="preload" href="/blog/_next/static/chunks/commons.08ddd7455f4143b98f8d.js" as="script"/><link rel="preload" href="/blog/_next/static/chunks/pages/_app-3bdda458aa4ad17304fc.js" as="script"/><link rel="preload" href="/blog/_next/static/chunks/06447f4e.e11bbf63b9bfcd126107.js" as="script"/><link rel="preload" href="/blog/_next/static/chunks/c78d26b1.84adfeb932354ef9a95e.js" as="script"/><link rel="preload" href="/blog/_next/static/chunks/768876d20c0ee2e540736d254e2790c53bb785f0.2a06644f067446519e2a.js" as="script"/><link rel="preload" href="/blog/_next/static/chunks/pages/post-4163277423727bcbd85f.js" as="script"/></head><body><div id="__next"><div class="jsx-2809278127"><div><main class="lh-copy"><div class="relative tc bg-dark-gray"><div class="mw7 center white"><div class="pv4"><h1 class="f2 normal lh-title ma0 pa0"><a class="white no-underline" href="/blog/">phiresky&#x27;s blog</a></h1><h4 class="normal o-70 ma0 pt2 pb3 ph1">About my personal projects and other stuff</h4><div><a href="https://phiresky.github.io/blog/" class="dib f6 white no-underline pa1 ma1">Blog</a><a href="https://github.com/phiresky/" class="dib f6 white no-underline pa1 ma1">GitHub</a></div></div></div></div><div class="jsx-2809278127 content center mw7 pa3 pa4-ns"><h1 class="jsx-2809278127 mt0 lh-title mb1">10 underused features of modern Python [incomplete]</h1><small class="db ttu o-40"><time dateTime="2021-02-15T00:00:00.000Z">Feb 15, 2021</time></small><h2 id="named-tuple">Named tuple</h2><pre style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-py" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token token" style="color:#cc99cd">from</span><span> typing </span><span class="token token" style="color:#cc99cd">import</span><span> NamedTuple
</span>
<span></span><span class="token token" style="color:#cc99cd">class</span><span> </span><span class="token token" style="color:#f8c555">EnvParams</span><span class="token token" style="color:#ccc">(</span><span>NamedTuple</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    name</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#cc99cd">str</span><span>
</span><span>    nr_agents</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#cc99cd">int</span><span>
</span><span>    mode</span><span class="token token" style="color:#ccc">:</span><span> Literal</span><span class="token token" style="color:#ccc">[</span><span class="token token" style="color:#7ec699">&quot;uniform&quot;</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#7ec699">&quot;relative&quot;</span><span class="token token" style="color:#ccc">]</span><span> </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#7ec699">&quot;uniform&quot;</span><span>
</span>
<span></span><span class="token token" style="color:#cc99cd">def</span><span> </span><span class="token token" style="color:#f08d49">get_params</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span> </span><span class="token token" style="color:#67cdcc">-</span><span class="token token" style="color:#67cdcc">&gt;</span><span> EnvParams</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    </span><span class="token token" style="color:#cc99cd">return</span><span> EnvParams</span><span class="token token" style="color:#ccc">(</span><span>name</span><span class="token token" style="color:#67cdcc">=</span><span class="token token" style="color:#7ec699">&quot;hello&quot;</span><span class="token token" style="color:#ccc">,</span><span> nr_agents</span><span class="token token" style="color:#67cdcc">=</span><span class="token token" style="color:#f08d49">42</span><span class="token token" style="color:#ccc">)</span></code></pre><ul><li>automatic constructor generation etc</li><li>strong typing</li><li>immutable</li><li>same memory usage as normal tuples</li><li>default values</li><li>more safety than tuples, access <code>params.name</code> like objects, order does not matter</li><li>compatible API with tuples</li></ul><h2 id="typing">Typing</h2><h2 id="f-strings">F strings</h2><pre style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-py" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token token" style="color:#cc99cd">def</span><span> </span><span class="token token" style="color:#f08d49">fn</span><span class="token token" style="color:#ccc">(</span><span>x</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>  </span><span class="token token" style="color:#cc99cd">return</span><span> x </span><span class="token token" style="color:#67cdcc">*</span><span> x
</span>
<span>x </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#f08d49">5</span><span>
</span><span></span><span class="token token" style="color:#cc99cd">print</span><span class="token token" style="color:#ccc">(</span><span class="token token string-interpolation" style="color:#7ec699">f&quot;for input </span><span class="token token string-interpolation interpolation" style="color:#ccc">{</span><span class="token token string-interpolation interpolation">x</span><span class="token token string-interpolation interpolation" style="color:#ccc">:</span><span class="token token string-interpolation interpolation format-spec">.1f</span><span class="token token string-interpolation interpolation" style="color:#ccc">}</span><span class="token token string-interpolation" style="color:#7ec699">, </span><span class="token token string-interpolation interpolation" style="color:#ccc">{</span><span class="token token string-interpolation interpolation">fn</span><span class="token token string-interpolation interpolation" style="color:#ccc">(</span><span class="token token string-interpolation interpolation">x</span><span class="token token string-interpolation interpolation" style="color:#ccc">)</span><span class="token token string-interpolation interpolation" style="color:#67cdcc">=</span><span class="token token string-interpolation interpolation" style="color:#ccc">}</span><span class="token token string-interpolation" style="color:#7ec699">&quot;</span><span class="token token" style="color:#ccc">)</span></code></pre><p>Prints: <code>for input 5.0, fn(x)=25</code></p><p>Similar to <code>&quot;x is {x}&quot;.format(x=x)</code> but easier to read and write. You can add simple expression inside the {}. The special format specifier <code>f&quot;{foo=}&quot;</code> is the same as doing <code>f&quot;foo={foo}&quot;</code></p><h2 id="pathlib">Pathlib</h2><pre style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-py" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token token" style="color:#cc99cd">from</span><span> pathlib </span><span class="token token" style="color:#cc99cd">import</span><span> Path
</span>
<span>mydir </span><span class="token token" style="color:#67cdcc">=</span><span> Path</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#7ec699">&quot;foo&quot;</span><span class="token token" style="color:#ccc">)</span><span>
</span>
<span>myfile </span><span class="token token" style="color:#67cdcc">=</span><span> mydir </span><span class="token token" style="color:#67cdcc">/</span><span> </span><span class="token token" style="color:#7ec699">&quot;filename.txt&quot;</span></code></pre><p>If you pass file paths around as strings, you have to figure out when to add slashes and when not to, and unless you always use <code>os.path.sep</code> your code will work differently depending on the OS.</p><p><code>Path</code>s have great methods for manipulating filenames that are much more readable than their <code>os.path</code> equivalents:</p><pre style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-py" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>myfile </span><span class="token token" style="color:#67cdcc">=</span><span> Path</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#7ec699">&quot;foo/filename.txt&quot;</span><span class="token token" style="color:#ccc">)</span><span>
</span><span>myfile</span><span class="token token" style="color:#ccc">.</span><span>parent </span><span class="token token" style="color:#999"># Path(&quot;foo&quot;)</span><span>
</span><span>myfile</span><span class="token token" style="color:#ccc">.</span><span>name </span><span class="token token" style="color:#999"># &quot;filename.txt&quot;</span><span>
</span><span>myfile</span><span class="token token" style="color:#ccc">.</span><span>suffix </span><span class="token token" style="color:#999"># &quot;.txt&quot;</span><span>
</span><span></span><span class="token token" style="color:#999"># replace file extension</span><span>
</span><span>myfile</span><span class="token token" style="color:#ccc">.</span><span>with_suffix</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#7ec699">&#x27;.csv&#x27;</span><span class="token token" style="color:#ccc">)</span><span> </span><span class="token token" style="color:#999"># foo/filename.csv</span></code></pre><p><code>Path</code>s also have neat methods for opening / reading / writing files:</p><pre style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-py" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>myfile</span><span class="token token" style="color:#ccc">.</span><span>write_text</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#7ec699">&quot;hello&quot;</span><span class="token token" style="color:#ccc">)</span><span>
</span>
<span></span><span class="token token" style="color:#cc99cd">if</span><span> myfile</span><span class="token token" style="color:#ccc">.</span><span>exists</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>  </span><span class="token token" style="color:#cc99cd">with</span><span> myfile</span><span class="token token" style="color:#ccc">.</span><span class="token token" style="color:#cc99cd">open</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#7ec699">&quot;r&quot;</span><span class="token token" style="color:#ccc">)</span><span> </span><span class="token token" style="color:#cc99cd">as</span><span> f</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    </span><span class="token token" style="color:#999"># ...</span><span>
</span><span>    </span><span class="token token" style="color:#cc99cd">pass</span><span>
</span>
<span>text </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#ccc">(</span><span>mydir </span><span class="token token" style="color:#67cdcc">/</span><span> </span><span class="token token" style="color:#7ec699">&quot;input.txt&quot;</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">.</span><span>read_text</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span>
</span>
<!-- -->
<span></span><span class="token token" style="color:#cc99cd">for</span><span> </span><span class="token token" style="color:#cc99cd">file</span><span> </span><span class="token token" style="color:#cc99cd">in</span><span> Path</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#7ec699">&quot;foo&quot;</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">.</span><span>glob</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#7ec699">&quot;*.txt&quot;</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>  </span><span class="token token" style="color:#999"># every txt file in foo/</span><span>
</span><span>  </span><span class="token token" style="color:#cc99cd">pass</span></code></pre><h2 id="relative-imports">Relative imports</h2><p>The following is fairly common python code:</p><pre style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>import util
</span>
<!-- -->util.foo()
</code></pre><p>But what is <code>util</code>? It can be either a global module or a local file / directory. If there is a local file named <code>util.py</code>, it will shadow the corresponding module. This is a pretty common issue, and happens even to <a href="https://github.com/pytorch/pytorch/issues/24807#issuecomment-524155619">experienced devs</a>.</p><p>Instead, in my opinion you should always use relative imports if you want to import a relative module instead of global ones.</p><pre style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-py" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token token" style="color:#cc99cd">from</span><span> </span><span class="token token" style="color:#ccc">.</span><span> </span><span class="token token" style="color:#cc99cd">import</span><span> util
</span><span></span><span class="token token" style="color:#999"># or</span><span>
</span><span></span><span class="token token" style="color:#cc99cd">from</span><span> </span><span class="token token" style="color:#ccc">.</span><span>util </span><span class="token token" style="color:#cc99cd">import</span><span> foo</span></code></pre><p>Sadly this ambiguity issue is not completely fixeable without a breaking change in python itself, and due to a bad design decision in the Python module system relative imports have <a href="https://stackoverflow.com/a/28154841/2639190">some issues when python files are loaded in a specific way called <span class="quoted">&quot;<!-- -->script mode<!-- -->&quot;</span></a>, which you will probably come across sooner or later.</p><h2 id="ordered-unordered-dicts">Ordered unordered dicts</h2><p>Since Python 3.6, Python uses a more compact representation of dicts (and thus <code>kwargs</code>). Since Python 3.7, it is guaranteed that dicts are always iterated over in insertion order.</p><p>This means that every dict is basically an <code>OrderedDict</code> except some utility functions are missing. This is really useful, because it means you can use normal dicts as ordered associative arrays.</p><pre style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-py" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>x </span><span class="token token" style="color:#67cdcc">=</span><span> </span><span class="token token" style="color:#ccc">{</span><span>
</span><span>  </span><span class="token token" style="color:#7ec699">&quot;c&quot;</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#f08d49">True</span><span class="token token" style="color:#ccc">,</span><span>
</span><span>  </span><span class="token token" style="color:#7ec699">&quot;b&quot;</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#f08d49">False</span><span class="token token" style="color:#ccc">,</span><span>
</span><span>  </span><span class="token token" style="color:#7ec699">&quot;d&quot;</span><span class="token token" style="color:#ccc">:</span><span> </span><span class="token token" style="color:#f08d49">False</span><span>
</span><span></span><span class="token token" style="color:#ccc">}</span><span>
</span><span></span><span class="token token" style="color:#cc99cd">for</span><span> key </span><span class="token token" style="color:#cc99cd">in</span><span> x</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    </span><span class="token token" style="color:#999"># guaranteed to always go through keys in the order &quot;c&quot;, &quot;b&quot;, &quot;d&quot;!</span></code></pre><h1 id="multiprocessing">Multiprocessing</h1><p>There’s a ton of libraries for multithreading / multiprocessing in python, with varying degrees of magicness. But in Python 3, there’s actually an integrated way to run a function on a large set of data quickly: <a href="https://docs.python.org/3/library/multiprocessing.html"><code>multiprocessing.Pool</code></a></p><pre style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-py" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token token" style="color:#cc99cd">def</span><span> </span><span class="token token" style="color:#f08d49">f</span><span class="token token" style="color:#ccc">(</span><span>x</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    </span><span class="token token" style="color:#999"># expensive computation</span><span>
</span><span>    </span><span class="token token" style="color:#cc99cd">return</span><span> x </span><span class="token token" style="color:#67cdcc">*</span><span> x
</span>
<span></span><span class="token token" style="color:#cc99cd">from</span><span> multiprocessing </span><span class="token token" style="color:#cc99cd">import</span><span> Pool
</span>
<span></span><span class="token token" style="color:#cc99cd">with</span><span> Pool</span><span class="token token" style="color:#ccc">(</span><span class="token token" style="color:#ccc">)</span><span> </span><span class="token token" style="color:#cc99cd">as</span><span> p</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>    </span><span class="token token" style="color:#cc99cd">for</span><span> result </span><span class="token token" style="color:#cc99cd">in</span><span> p</span><span class="token token" style="color:#ccc">.</span><span>imap</span><span class="token token" style="color:#ccc">(</span><span>f</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#ccc">[</span><span class="token token" style="color:#f08d49">1</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#f08d49">2</span><span class="token token" style="color:#ccc">,</span><span> </span><span class="token token" style="color:#f08d49">3</span><span class="token token" style="color:#ccc">]</span><span class="token token" style="color:#ccc">,</span><span> chunksize</span><span class="token token" style="color:#67cdcc">=</span><span class="token token" style="color:#f08d49">100</span><span class="token token" style="color:#ccc">)</span><span class="token token" style="color:#ccc">:</span><span>
</span><span>      </span><span class="token token" style="color:#999"># ... handle result</span></code></pre><p>This code does the same as <code>for i in [1,2,3]: f(i)</code> except using all your CPU cores.</p><h2 id="poetry">Poetry</h2><p>Here is all the stages of a Python developer’s slow decent into madness:</p><ol start="1" type="1"><li><p>You write single file .py scripts without imports and functions. It’s so easy to get so much done! You feel enlightened.</p></li><li><p>You start splitting your code in multiple functions in .py files, and feel enlightened of how structured your code is now.</p></li><li><p>You need to do some maths, so you learn about <code>pip</code> and run <code>pip install numpy</code> globally. You feel enlightened about how easy it is to use libraries. It’s as easy as <a href="https://xkcd.com/353/">import antigravity</a>!</p></li><li><p>At some point you have some multiple projects that need different versions of some libraries. You learn about virtualenvs. You are confused about the difference between <code>venv</code>, <code>virtualenv</code>, <code>virtualenvwrapper</code>, but some random memorized commands works so you start using virtualenvs.</p></li><li><p>You try to use some older library from GitHub. You learn about <code>setup.py</code> files and <code>requirements.txt</code> files, and you feel enlightened! This is how you define exactly what you need to run your program! The project you’re trying to use has a requirements.txt file like this:</p><pre style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>pandas
</span>numpy
</code></pre><p>So you eagerly run</p><pre style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-sh" style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>python -m venv .venv
</span>source .venv/bin/activate
<!-- -->pip install -r requirements.txt
</code></pre><p>Then you try running the project, but it turns out it actually also needs <code>sklearn</code>. So you try <code>pip install sklearn</code> only to realize that <code>sklearn</code> is actually a random package from someone else and to get <code>sklearn</code> you actually need to install <code>scikit-learn</code>. You realize that package names are not actually related to the names of python modules (except incidentally) and feel enlightened by the power!</p><p>But the code still doesn’t run, theer’s some weird issue. After an hour of investigation, you find some obscure bug <a href="http://blog.khinsen.net/posts/2017/11/16/a-plea-for-stability-in-the-scipy-ecosystem/">caused by an incompatible change</a> some time 5 years ago in numpy. You try some old numpy versions until you find one that works. You learn about semver and freezing, and you feel enlightened! The developer should have just put <code>numpy==1.10</code> into their requirements.txt!</p></li><li><p>You find <a href="https://pytorch.org/get-started/locally/">something that recommends using Conda</a>. You are somewhat confused why the conda download is taking so long and eats up 2GB of bandwidth. After accepting a random EULA and having your shell changed prompt always say <code>(base) $</code>, you realize that in conda, everything is an env! It’s so quick to add libraries, <a href="https://anaconda.org/anaconda/mkl">even weird native ones</a> ! You feel enlightened.</p></li><li><p>You read some documentation and call a python function, but the function does not exist. After some reading, you see that the package you installed via conda is an outdated version. You now understand that conda is a completely different package manager from pip, and that conda packages are actually managed by third parties, some of which are outdated, and many don’t exist at all. You start using <code>pip</code> for some things and <code>conda</code> for other things, all in the same environment.</p></li><li><p>The find out about the Official Modern Python Packaging tool <a href="https://pipenv.pypa.io/en/latest/">pipenv</a>! Pipenv always and automatically manages a virtualenv with the exact dependencies as defined in a <code>Pipfile</code>, which is like a supercharged <code>requirements.txt</code>. It’s amazing! Except you soon try to install a package and get a <code>Could not resolve dependencies</code> error. You google a while, and figure out that most pypi packages don’t actually have correctly specified dependencies, and that pip just doesn’t really care about that. You also find out that <a href="https://chriswarrick.com/blog/2018/07/17/pipenv-promises-a-lot-delivers-very-little/">pipenv only really pretended to be an official tool</a>.</p></li><li><p>You find out about <a href="https://python-poetry.org/">poetry</a>. It’s like pipenv but actually good! It only takes 2 minutes to resolve dependencies instead of 10! It even puts your virtualenv in <code>~/.cache</code> because it <em>really</em> doesn’t matter if it gets deleted!</p></li></ol><h1 id="typed-argparse">Typed Argparse</h1><p>Argparse is a neat library to create a simple command line interface. But arguments are declared as strings, and the IDE can’t know about them.</p><p>With <a href="https://github.com/swansonk14/typed-argument-parser">Typed-Argparse</a>, your arguments are parsed directly into a class instance!</p><p><img src="https://raw.githubusercontent.com/swansonk14/typed-argument-parser/master/images/tap.png" title="fig:"/></p><pre style="color:#ccc;background:#2d2d2d;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code style="color:#ccc;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>```
</span>
<!-- -->```
<!-- -->
<!-- -->```
<!-- -->
<!-- -->```
<!-- -->
<!-- -->```
<!-- -->
<!-- -->```
</code></pre></div><footer class="center w5 f6 tc mt4"><p><a href="https://github.com/phiresky/blog/blob/master/posts/2021/python-features.md">View post source on GitHub</a></p></footer><div><script>/* yes, I know... fite me */
  (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
  function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
  e=o.createElement(i);r=o.getElementsByTagName(i)[0];
  e.src='https://www.google-analytics.com/analytics.js';
  r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
  ga('create','UA-39197996-3','auto');ga('send','pageview');
</script></div></main></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"default":{"filename":"2021/python-features.md","frontmatter":{"csl":"../ieee-with-url.csl","date":"2021-02-15","hidden":true,"references":[],"subtitle":"","title":"10 underused features of modern Python [incomplete]","url2cite-link-output":"sup"},"preview":"Named tupleautomatic constructor generation etcstrong typingimmutablesame memory usage as normal tuplesdefault valuesmore safety than tuples, access params.name like objects, order does not mattercompatible API with tuplesTypingF strings Prints: for input 5.0, fn(x)=25 Similar to \"x is","content_ast":[{"t":"Header","c":[2,["named-tuple",[],[]],[{"t":"Str","c":"Named tuple"}]]},{"t":"CodeBlock","c":[["",["py"],[]],"from typing import NamedTuple\n\nclass EnvParams(NamedTuple):\n    name: str\n    nr_agents: int\n    mode: Literal[\"uniform\", \"relative\"] = \"uniform\"\n\ndef get_params() -\u003e EnvParams:\n    return EnvParams(name=\"hello\", nr_agents=42)"]},{"t":"BulletList","c":[[{"t":"Plain","c":[{"t":"Str","c":"automatic constructor generation etc"}]}],[{"t":"Plain","c":[{"t":"Str","c":"strong typing"}]}],[{"t":"Plain","c":[{"t":"Str","c":"immutable"}]}],[{"t":"Plain","c":[{"t":"Str","c":"same memory usage as normal tuples"}]}],[{"t":"Plain","c":[{"t":"Str","c":"default values"}]}],[{"t":"Plain","c":[{"t":"Str","c":"more safety than tuples, access "},{"t":"Code","c":[["",[],[]],"params.name"]},{"t":"Str","c":" like objects, order does not matter"}]}],[{"t":"Plain","c":[{"t":"Str","c":"compatible API with tuples"}]}]]},{"t":"Header","c":[2,["typing",[],[]],[{"t":"Str","c":"Typing"}]]},{"t":"Header","c":[2,["f-strings",[],[]],[{"t":"Str","c":"F strings"}]]},{"t":"CodeBlock","c":[["",["py"],[]],"def fn(x):\n  return x * x\n\nx = 5\nprint(f\"for input {x:.1f}, {fn(x)=}\")"]},{"t":"Para","c":[{"t":"Str","c":"Prints: "},{"t":"Code","c":[["",[],[]],"for input 5.0, fn(x)=25"]}]},{"t":"Para","c":[{"t":"Str","c":"Similar to "},{"t":"Code","c":[["",[],[]],"\"x is {x}\".format(x=x)"]},{"t":"Str","c":" but easier to read and write. You can add simple expression inside the {}. The special format specifier "},{"t":"Code","c":[["",[],[]],"f\"{foo=}\""]},{"t":"Str","c":" is the same as doing "},{"t":"Code","c":[["",[],[]],"f\"foo={foo}\""]}]},{"t":"Header","c":[2,["pathlib",[],[]],[{"t":"Str","c":"Pathlib"}]]},{"t":"CodeBlock","c":[["",["py"],[]],"from pathlib import Path\n\nmydir = Path(\"foo\")\n\nmyfile = mydir / \"filename.txt\""]},{"t":"Para","c":[{"t":"Str","c":"If you pass file paths around as strings, you have to figure out when to add slashes and when not to, and unless you always use "},{"t":"Code","c":[["",[],[]],"os.path.sep"]},{"t":"Str","c":" your code will work differently depending on the OS."}]},{"t":"Para","c":[{"t":"Code","c":[["",[],[]],"Path"]},{"t":"Str","c":"s have great methods for manipulating filenames that are much more readable than their "},{"t":"Code","c":[["",[],[]],"os.path"]},{"t":"Str","c":" equivalents:"}]},{"t":"CodeBlock","c":[["",["py"],[]],"myfile = Path(\"foo/filename.txt\")\nmyfile.parent # Path(\"foo\")\nmyfile.name # \"filename.txt\"\nmyfile.suffix # \".txt\"\n# replace file extension\nmyfile.with_suffix('.csv') # foo/filename.csv"]},{"t":"Para","c":[{"t":"Code","c":[["",[],[]],"Path"]},{"t":"Str","c":"s also have neat methods for opening / reading / writing files:"}]},{"t":"CodeBlock","c":[["",["py"],[]],"myfile.write_text(\"hello\")\n\nif myfile.exists():\n  with myfile.open(\"r\") as f:\n    # ...\n    pass\n\ntext = (mydir / \"input.txt\").read_text()\n\n\nfor file in Path(\"foo\").glob(\"*.txt\"):\n  # every txt file in foo/\n  pass"]},{"t":"Header","c":[2,["relative-imports",[],[]],[{"t":"Str","c":"Relative imports"}]]},{"t":"Para","c":[{"t":"Str","c":"The following is fairly common python code:"}]},{"t":"CodeBlock","c":[["",[],[]],"import util\n\nutil.foo()"]},{"t":"Para","c":[{"t":"Str","c":"But what is "},{"t":"Code","c":[["",[],[]],"util"]},{"t":"Str","c":"? It can be either a global module or a local file / directory. If there is a local file named "},{"t":"Code","c":[["",[],[]],"util.py"]},{"t":"Str","c":", it will shadow the corresponding module. This is a pretty common issue, and happens even to "},{"t":"Link","c":[["",[],[]],[{"t":"Str","c":"experienced devs"}],["https://github.com/pytorch/pytorch/issues/24807#issuecomment-524155619",""]]},{"t":"Str","c":"."}]},{"t":"Para","c":[{"t":"Str","c":"Instead, in my opinion you should always use relative imports if you want to import a relative module instead of global ones."}]},{"t":"CodeBlock","c":[["",["py"],[]],"from . import util\n# or\nfrom .util import foo"]},{"t":"Para","c":[{"t":"Str","c":"Sadly this ambiguity issue is not completely fixeable without a breaking change in python itself, and due to a bad design decision in the Python module system relative imports have "},{"t":"Link","c":[["",[],[]],[{"t":"Str","c":"some issues when python files are loaded in a specific way called "},{"t":"Quoted","c":[{"t":"DoubleQuote"},[{"t":"Str","c":"script mode"}]]}],["https://stackoverflow.com/a/28154841/2639190",""]]},{"t":"Str","c":", which you will probably come across sooner or later."}]},{"t":"Header","c":[2,["ordered-unordered-dicts",[],[]],[{"t":"Str","c":"Ordered unordered dicts"}]]},{"t":"Para","c":[{"t":"Str","c":"Since Python 3.6, Python uses a more compact representation of dicts (and thus "},{"t":"Code","c":[["",[],[]],"kwargs"]},{"t":"Str","c":"). Since Python 3.7, it is guaranteed that dicts are always iterated over in insertion order."}]},{"t":"Para","c":[{"t":"Str","c":"This means that every dict is basically an "},{"t":"Code","c":[["",[],[]],"OrderedDict"]},{"t":"Str","c":" except some utility functions are missing. This is really useful, because it means you can use normal dicts as ordered associative arrays."}]},{"t":"CodeBlock","c":[["",["py"],[]],"x = {\n  \"c\": True,\n  \"b\": False,\n  \"d\": False\n}\nfor key in x:\n    # guaranteed to always go through keys in the order \"c\", \"b\", \"d\"!"]},{"t":"Header","c":[1,["multiprocessing",[],[]],[{"t":"Str","c":"Multiprocessing"}]]},{"t":"Para","c":[{"t":"Str","c":"There’s a ton of libraries for multithreading / multiprocessing in python, with varying degrees of magicness. But in Python 3, there’s actually an integrated way to run a function on a large set of data quickly: "},{"t":"Link","c":[["",[],[]],[{"t":"Code","c":[["",[],[]],"multiprocessing.Pool"]}],["https://docs.python.org/3/library/multiprocessing.html",""]]}]},{"t":"CodeBlock","c":[["",["py"],[]],"def f(x):\n    # expensive computation\n    return x * x\n\nfrom multiprocessing import Pool\n\nwith Pool() as p:\n    for result in p.imap(f, [1, 2, 3], chunksize=100):\n      # ... handle result"]},{"t":"Para","c":[{"t":"Str","c":"This code does the same as "},{"t":"Code","c":[["",[],[]],"for i in [1,2,3]: f(i)"]},{"t":"Str","c":" except using all your CPU cores."}]},{"t":"Header","c":[2,["poetry",[],[]],[{"t":"Str","c":"Poetry"}]]},{"t":"Para","c":[{"t":"Str","c":"Here is all the stages of a Python developer’s slow decent into madness:"}]},{"t":"OrderedList","c":[[1,{"t":"Decimal"},{"t":"Period"}],[[{"t":"Para","c":[{"t":"Str","c":"You write single file .py scripts without imports and functions. It’s so easy to get so much done! You feel enlightened."}]}],[{"t":"Para","c":[{"t":"Str","c":"You start splitting your code in multiple functions in .py files, and feel enlightened of how structured your code is now."}]}],[{"t":"Para","c":[{"t":"Str","c":"You need to do some maths, so you learn about "},{"t":"Code","c":[["",[],[]],"pip"]},{"t":"Str","c":" and run "},{"t":"Code","c":[["",[],[]],"pip install numpy"]},{"t":"Str","c":" globally. You feel enlightened about how easy it is to use libraries. It’s as easy as "},{"t":"Link","c":[["",[],[]],[{"t":"Str","c":"import antigravity"}],["https://xkcd.com/353/",""]]},{"t":"Str","c":"!"}]}],[{"t":"Para","c":[{"t":"Str","c":"At some point you have some multiple projects that need different versions of some libraries. You learn about virtualenvs. You are confused about the difference between "},{"t":"Code","c":[["",[],[]],"venv"]},{"t":"Str","c":", "},{"t":"Code","c":[["",[],[]],"virtualenv"]},{"t":"Str","c":", "},{"t":"Code","c":[["",[],[]],"virtualenvwrapper"]},{"t":"Str","c":", but some random memorized commands works so you start using virtualenvs."}]}],[{"t":"Para","c":[{"t":"Str","c":"You try to use some older library from GitHub. You learn about "},{"t":"Code","c":[["",[],[]],"setup.py"]},{"t":"Str","c":" files and "},{"t":"Code","c":[["",[],[]],"requirements.txt"]},{"t":"Str","c":" files, and you feel enlightened! This is how you define exactly what you need to run your program! The project you’re trying to use has a requirements.txt file like this:"}]},{"t":"CodeBlock","c":[["",[],[]],"pandas\nnumpy"]},{"t":"Para","c":[{"t":"Str","c":"So you eagerly run"}]},{"t":"CodeBlock","c":[["",["sh"],[]],"python -m venv .venv\nsource .venv/bin/activate\npip install -r requirements.txt"]},{"t":"Para","c":[{"t":"Str","c":"Then you try running the project, but it turns out it actually also needs "},{"t":"Code","c":[["",[],[]],"sklearn"]},{"t":"Str","c":". So you try "},{"t":"Code","c":[["",[],[]],"pip install sklearn"]},{"t":"Str","c":" only to realize that "},{"t":"Code","c":[["",[],[]],"sklearn"]},{"t":"Str","c":" is actually a random package from someone else and to get "},{"t":"Code","c":[["",[],[]],"sklearn"]},{"t":"Str","c":" you actually need to install "},{"t":"Code","c":[["",[],[]],"scikit-learn"]},{"t":"Str","c":". You realize that package names are not actually related to the names of python modules (except incidentally) and feel enlightened by the power!"}]},{"t":"Para","c":[{"t":"Str","c":"But the code still doesn’t run, theer’s some weird issue. After an hour of investigation, you find some obscure bug "},{"t":"Link","c":[["",[],[]],[{"t":"Str","c":"caused by an incompatible change"}],["http://blog.khinsen.net/posts/2017/11/16/a-plea-for-stability-in-the-scipy-ecosystem/",""]]},{"t":"Str","c":" some time 5 years ago in numpy. You try some old numpy versions until you find one that works. You learn about semver and freezing, and you feel enlightened! The developer should have just put "},{"t":"Code","c":[["",[],[]],"numpy==1.10"]},{"t":"Str","c":" into their requirements.txt!"}]}],[{"t":"Para","c":[{"t":"Str","c":"You find "},{"t":"Link","c":[["",[],[]],[{"t":"Str","c":"something that recommends using Conda"}],["https://pytorch.org/get-started/locally/",""]]},{"t":"Str","c":". You are somewhat confused why the conda download is taking so long and eats up 2GB of bandwidth. After accepting a random EULA and having your shell changed prompt always say "},{"t":"Code","c":[["",[],[]],"(base) $"]},{"t":"Str","c":", you realize that in conda, everything is an env! It’s so quick to add libraries, "},{"t":"Link","c":[["",[],[]],[{"t":"Str","c":"even weird native ones"}],["https://anaconda.org/anaconda/mkl",""]]},{"t":"Str","c":" ! You feel enlightened."}]}],[{"t":"Para","c":[{"t":"Str","c":"You read some documentation and call a python function, but the function does not exist. After some reading, you see that the package you installed via conda is an outdated version. You now understand that conda is a completely different package manager from pip, and that conda packages are actually managed by third parties, some of which are outdated, and many don’t exist at all. You start using "},{"t":"Code","c":[["",[],[]],"pip"]},{"t":"Str","c":" for some things and "},{"t":"Code","c":[["",[],[]],"conda"]},{"t":"Str","c":" for other things, all in the same environment."}]}],[{"t":"Para","c":[{"t":"Str","c":"The find out about the Official Modern Python Packaging tool "},{"t":"Link","c":[["",[],[]],[{"t":"Str","c":"pipenv"}],["https://pipenv.pypa.io/en/latest/",""]]},{"t":"Str","c":"! Pipenv always and automatically manages a virtualenv with the exact dependencies as defined in a "},{"t":"Code","c":[["",[],[]],"Pipfile"]},{"t":"Str","c":", which is like a supercharged "},{"t":"Code","c":[["",[],[]],"requirements.txt"]},{"t":"Str","c":". It’s amazing! Except you soon try to install a package and get a "},{"t":"Code","c":[["",[],[]],"Could not resolve dependencies"]},{"t":"Str","c":" error. You google a while, and figure out that most pypi packages don’t actually have correctly specified dependencies, and that pip just doesn’t really care about that. You also find out that "},{"t":"Link","c":[["",[],[]],[{"t":"Str","c":"pipenv only really pretended to be an official tool"}],["https://chriswarrick.com/blog/2018/07/17/pipenv-promises-a-lot-delivers-very-little/",""]]},{"t":"Str","c":"."}]}],[{"t":"Para","c":[{"t":"Str","c":"You find out about "},{"t":"Link","c":[["",[],[]],[{"t":"Str","c":"poetry"}],["https://python-poetry.org/",""]]},{"t":"Str","c":". It’s like pipenv but actually good! It only takes 2 minutes to resolve dependencies instead of 10! It even puts your virtualenv in "},{"t":"Code","c":[["",[],[]],"~/.cache"]},{"t":"Str","c":" because it "},{"t":"Emph","c":[{"t":"Str","c":"really"}]},{"t":"Str","c":" doesn’t matter if it gets deleted!"}]}]]]},{"t":"Header","c":[1,["typed-argparse",[],[]],[{"t":"Str","c":"Typed Argparse"}]]},{"t":"Para","c":[{"t":"Str","c":"Argparse is a neat library to create a simple command line interface. But arguments are declared as strings, and the IDE can’t know about them."}]},{"t":"Para","c":[{"t":"Str","c":"With "},{"t":"Link","c":[["",[],[]],[{"t":"Str","c":"Typed-Argparse"}],["https://github.com/swansonk14/typed-argument-parser",""]]},{"t":"Str","c":", your arguments are parsed directly into a class instance!"}]},{"t":"Para","c":[{"t":"Image","c":[["",[],[]],[{"t":"Str","c":"TAP example"}],["https://raw.githubusercontent.com/swansonk14/typed-argument-parser/master/images/tap.png","fig:"]]}]},{"t":"CodeBlock","c":[["",[],[]],"\n```\n\n```\n\n```\n\n```\n\n```\n\n```"]}]},"filename":"2021/python-features.md","frontmatter":{"csl":"../ieee-with-url.csl","date":"2021-02-15","hidden":true,"references":[],"subtitle":"","title":"10 underused features of modern Python [incomplete]","url2cite-link-output":"sup"},"preview":"Named tupleautomatic constructor generation etcstrong typingimmutablesame memory usage as normal tuplesdefault valuesmore safety than tuples, access params.name like objects, order does not mattercompatible API with tuplesTypingF strings Prints: for input 5.0, fn(x)=25 Similar to \"x is","content_ast":[{"t":"Header","c":[2,["named-tuple",[],[]],[{"t":"Str","c":"Named tuple"}]]},{"t":"CodeBlock","c":[["",["py"],[]],"from typing import NamedTuple\n\nclass EnvParams(NamedTuple):\n    name: str\n    nr_agents: int\n    mode: Literal[\"uniform\", \"relative\"] = \"uniform\"\n\ndef get_params() -\u003e EnvParams:\n    return EnvParams(name=\"hello\", nr_agents=42)"]},{"t":"BulletList","c":[[{"t":"Plain","c":[{"t":"Str","c":"automatic constructor generation etc"}]}],[{"t":"Plain","c":[{"t":"Str","c":"strong typing"}]}],[{"t":"Plain","c":[{"t":"Str","c":"immutable"}]}],[{"t":"Plain","c":[{"t":"Str","c":"same memory usage as normal tuples"}]}],[{"t":"Plain","c":[{"t":"Str","c":"default values"}]}],[{"t":"Plain","c":[{"t":"Str","c":"more safety than tuples, access "},{"t":"Code","c":[["",[],[]],"params.name"]},{"t":"Str","c":" like objects, order does not matter"}]}],[{"t":"Plain","c":[{"t":"Str","c":"compatible API with tuples"}]}]]},{"t":"Header","c":[2,["typing",[],[]],[{"t":"Str","c":"Typing"}]]},{"t":"Header","c":[2,["f-strings",[],[]],[{"t":"Str","c":"F strings"}]]},{"t":"CodeBlock","c":[["",["py"],[]],"def fn(x):\n  return x * x\n\nx = 5\nprint(f\"for input {x:.1f}, {fn(x)=}\")"]},{"t":"Para","c":[{"t":"Str","c":"Prints: "},{"t":"Code","c":[["",[],[]],"for input 5.0, fn(x)=25"]}]},{"t":"Para","c":[{"t":"Str","c":"Similar to "},{"t":"Code","c":[["",[],[]],"\"x is {x}\".format(x=x)"]},{"t":"Str","c":" but easier to read and write. You can add simple expression inside the {}. The special format specifier "},{"t":"Code","c":[["",[],[]],"f\"{foo=}\""]},{"t":"Str","c":" is the same as doing "},{"t":"Code","c":[["",[],[]],"f\"foo={foo}\""]}]},{"t":"Header","c":[2,["pathlib",[],[]],[{"t":"Str","c":"Pathlib"}]]},{"t":"CodeBlock","c":[["",["py"],[]],"from pathlib import Path\n\nmydir = Path(\"foo\")\n\nmyfile = mydir / \"filename.txt\""]},{"t":"Para","c":[{"t":"Str","c":"If you pass file paths around as strings, you have to figure out when to add slashes and when not to, and unless you always use "},{"t":"Code","c":[["",[],[]],"os.path.sep"]},{"t":"Str","c":" your code will work differently depending on the OS."}]},{"t":"Para","c":[{"t":"Code","c":[["",[],[]],"Path"]},{"t":"Str","c":"s have great methods for manipulating filenames that are much more readable than their "},{"t":"Code","c":[["",[],[]],"os.path"]},{"t":"Str","c":" equivalents:"}]},{"t":"CodeBlock","c":[["",["py"],[]],"myfile = Path(\"foo/filename.txt\")\nmyfile.parent # Path(\"foo\")\nmyfile.name # \"filename.txt\"\nmyfile.suffix # \".txt\"\n# replace file extension\nmyfile.with_suffix('.csv') # foo/filename.csv"]},{"t":"Para","c":[{"t":"Code","c":[["",[],[]],"Path"]},{"t":"Str","c":"s also have neat methods for opening / reading / writing files:"}]},{"t":"CodeBlock","c":[["",["py"],[]],"myfile.write_text(\"hello\")\n\nif myfile.exists():\n  with myfile.open(\"r\") as f:\n    # ...\n    pass\n\ntext = (mydir / \"input.txt\").read_text()\n\n\nfor file in Path(\"foo\").glob(\"*.txt\"):\n  # every txt file in foo/\n  pass"]},{"t":"Header","c":[2,["relative-imports",[],[]],[{"t":"Str","c":"Relative imports"}]]},{"t":"Para","c":[{"t":"Str","c":"The following is fairly common python code:"}]},{"t":"CodeBlock","c":[["",[],[]],"import util\n\nutil.foo()"]},{"t":"Para","c":[{"t":"Str","c":"But what is "},{"t":"Code","c":[["",[],[]],"util"]},{"t":"Str","c":"? It can be either a global module or a local file / directory. If there is a local file named "},{"t":"Code","c":[["",[],[]],"util.py"]},{"t":"Str","c":", it will shadow the corresponding module. This is a pretty common issue, and happens even to "},{"t":"Link","c":[["",[],[]],[{"t":"Str","c":"experienced devs"}],["https://github.com/pytorch/pytorch/issues/24807#issuecomment-524155619",""]]},{"t":"Str","c":"."}]},{"t":"Para","c":[{"t":"Str","c":"Instead, in my opinion you should always use relative imports if you want to import a relative module instead of global ones."}]},{"t":"CodeBlock","c":[["",["py"],[]],"from . import util\n# or\nfrom .util import foo"]},{"t":"Para","c":[{"t":"Str","c":"Sadly this ambiguity issue is not completely fixeable without a breaking change in python itself, and due to a bad design decision in the Python module system relative imports have "},{"t":"Link","c":[["",[],[]],[{"t":"Str","c":"some issues when python files are loaded in a specific way called "},{"t":"Quoted","c":[{"t":"DoubleQuote"},[{"t":"Str","c":"script mode"}]]}],["https://stackoverflow.com/a/28154841/2639190",""]]},{"t":"Str","c":", which you will probably come across sooner or later."}]},{"t":"Header","c":[2,["ordered-unordered-dicts",[],[]],[{"t":"Str","c":"Ordered unordered dicts"}]]},{"t":"Para","c":[{"t":"Str","c":"Since Python 3.6, Python uses a more compact representation of dicts (and thus "},{"t":"Code","c":[["",[],[]],"kwargs"]},{"t":"Str","c":"). Since Python 3.7, it is guaranteed that dicts are always iterated over in insertion order."}]},{"t":"Para","c":[{"t":"Str","c":"This means that every dict is basically an "},{"t":"Code","c":[["",[],[]],"OrderedDict"]},{"t":"Str","c":" except some utility functions are missing. This is really useful, because it means you can use normal dicts as ordered associative arrays."}]},{"t":"CodeBlock","c":[["",["py"],[]],"x = {\n  \"c\": True,\n  \"b\": False,\n  \"d\": False\n}\nfor key in x:\n    # guaranteed to always go through keys in the order \"c\", \"b\", \"d\"!"]},{"t":"Header","c":[1,["multiprocessing",[],[]],[{"t":"Str","c":"Multiprocessing"}]]},{"t":"Para","c":[{"t":"Str","c":"There’s a ton of libraries for multithreading / multiprocessing in python, with varying degrees of magicness. But in Python 3, there’s actually an integrated way to run a function on a large set of data quickly: "},{"t":"Link","c":[["",[],[]],[{"t":"Code","c":[["",[],[]],"multiprocessing.Pool"]}],["https://docs.python.org/3/library/multiprocessing.html",""]]}]},{"t":"CodeBlock","c":[["",["py"],[]],"def f(x):\n    # expensive computation\n    return x * x\n\nfrom multiprocessing import Pool\n\nwith Pool() as p:\n    for result in p.imap(f, [1, 2, 3], chunksize=100):\n      # ... handle result"]},{"t":"Para","c":[{"t":"Str","c":"This code does the same as "},{"t":"Code","c":[["",[],[]],"for i in [1,2,3]: f(i)"]},{"t":"Str","c":" except using all your CPU cores."}]},{"t":"Header","c":[2,["poetry",[],[]],[{"t":"Str","c":"Poetry"}]]},{"t":"Para","c":[{"t":"Str","c":"Here is all the stages of a Python developer’s slow decent into madness:"}]},{"t":"OrderedList","c":[[1,{"t":"Decimal"},{"t":"Period"}],[[{"t":"Para","c":[{"t":"Str","c":"You write single file .py scripts without imports and functions. It’s so easy to get so much done! You feel enlightened."}]}],[{"t":"Para","c":[{"t":"Str","c":"You start splitting your code in multiple functions in .py files, and feel enlightened of how structured your code is now."}]}],[{"t":"Para","c":[{"t":"Str","c":"You need to do some maths, so you learn about "},{"t":"Code","c":[["",[],[]],"pip"]},{"t":"Str","c":" and run "},{"t":"Code","c":[["",[],[]],"pip install numpy"]},{"t":"Str","c":" globally. You feel enlightened about how easy it is to use libraries. It’s as easy as "},{"t":"Link","c":[["",[],[]],[{"t":"Str","c":"import antigravity"}],["https://xkcd.com/353/",""]]},{"t":"Str","c":"!"}]}],[{"t":"Para","c":[{"t":"Str","c":"At some point you have some multiple projects that need different versions of some libraries. You learn about virtualenvs. You are confused about the difference between "},{"t":"Code","c":[["",[],[]],"venv"]},{"t":"Str","c":", "},{"t":"Code","c":[["",[],[]],"virtualenv"]},{"t":"Str","c":", "},{"t":"Code","c":[["",[],[]],"virtualenvwrapper"]},{"t":"Str","c":", but some random memorized commands works so you start using virtualenvs."}]}],[{"t":"Para","c":[{"t":"Str","c":"You try to use some older library from GitHub. You learn about "},{"t":"Code","c":[["",[],[]],"setup.py"]},{"t":"Str","c":" files and "},{"t":"Code","c":[["",[],[]],"requirements.txt"]},{"t":"Str","c":" files, and you feel enlightened! This is how you define exactly what you need to run your program! The project you’re trying to use has a requirements.txt file like this:"}]},{"t":"CodeBlock","c":[["",[],[]],"pandas\nnumpy"]},{"t":"Para","c":[{"t":"Str","c":"So you eagerly run"}]},{"t":"CodeBlock","c":[["",["sh"],[]],"python -m venv .venv\nsource .venv/bin/activate\npip install -r requirements.txt"]},{"t":"Para","c":[{"t":"Str","c":"Then you try running the project, but it turns out it actually also needs "},{"t":"Code","c":[["",[],[]],"sklearn"]},{"t":"Str","c":". So you try "},{"t":"Code","c":[["",[],[]],"pip install sklearn"]},{"t":"Str","c":" only to realize that "},{"t":"Code","c":[["",[],[]],"sklearn"]},{"t":"Str","c":" is actually a random package from someone else and to get "},{"t":"Code","c":[["",[],[]],"sklearn"]},{"t":"Str","c":" you actually need to install "},{"t":"Code","c":[["",[],[]],"scikit-learn"]},{"t":"Str","c":". You realize that package names are not actually related to the names of python modules (except incidentally) and feel enlightened by the power!"}]},{"t":"Para","c":[{"t":"Str","c":"But the code still doesn’t run, theer’s some weird issue. After an hour of investigation, you find some obscure bug "},{"t":"Link","c":[["",[],[]],[{"t":"Str","c":"caused by an incompatible change"}],["http://blog.khinsen.net/posts/2017/11/16/a-plea-for-stability-in-the-scipy-ecosystem/",""]]},{"t":"Str","c":" some time 5 years ago in numpy. You try some old numpy versions until you find one that works. You learn about semver and freezing, and you feel enlightened! The developer should have just put "},{"t":"Code","c":[["",[],[]],"numpy==1.10"]},{"t":"Str","c":" into their requirements.txt!"}]}],[{"t":"Para","c":[{"t":"Str","c":"You find "},{"t":"Link","c":[["",[],[]],[{"t":"Str","c":"something that recommends using Conda"}],["https://pytorch.org/get-started/locally/",""]]},{"t":"Str","c":". You are somewhat confused why the conda download is taking so long and eats up 2GB of bandwidth. After accepting a random EULA and having your shell changed prompt always say "},{"t":"Code","c":[["",[],[]],"(base) $"]},{"t":"Str","c":", you realize that in conda, everything is an env! It’s so quick to add libraries, "},{"t":"Link","c":[["",[],[]],[{"t":"Str","c":"even weird native ones"}],["https://anaconda.org/anaconda/mkl",""]]},{"t":"Str","c":" ! You feel enlightened."}]}],[{"t":"Para","c":[{"t":"Str","c":"You read some documentation and call a python function, but the function does not exist. After some reading, you see that the package you installed via conda is an outdated version. You now understand that conda is a completely different package manager from pip, and that conda packages are actually managed by third parties, some of which are outdated, and many don’t exist at all. You start using "},{"t":"Code","c":[["",[],[]],"pip"]},{"t":"Str","c":" for some things and "},{"t":"Code","c":[["",[],[]],"conda"]},{"t":"Str","c":" for other things, all in the same environment."}]}],[{"t":"Para","c":[{"t":"Str","c":"The find out about the Official Modern Python Packaging tool "},{"t":"Link","c":[["",[],[]],[{"t":"Str","c":"pipenv"}],["https://pipenv.pypa.io/en/latest/",""]]},{"t":"Str","c":"! Pipenv always and automatically manages a virtualenv with the exact dependencies as defined in a "},{"t":"Code","c":[["",[],[]],"Pipfile"]},{"t":"Str","c":", which is like a supercharged "},{"t":"Code","c":[["",[],[]],"requirements.txt"]},{"t":"Str","c":". It’s amazing! Except you soon try to install a package and get a "},{"t":"Code","c":[["",[],[]],"Could not resolve dependencies"]},{"t":"Str","c":" error. You google a while, and figure out that most pypi packages don’t actually have correctly specified dependencies, and that pip just doesn’t really care about that. You also find out that "},{"t":"Link","c":[["",[],[]],[{"t":"Str","c":"pipenv only really pretended to be an official tool"}],["https://chriswarrick.com/blog/2018/07/17/pipenv-promises-a-lot-delivers-very-little/",""]]},{"t":"Str","c":"."}]}],[{"t":"Para","c":[{"t":"Str","c":"You find out about "},{"t":"Link","c":[["",[],[]],[{"t":"Str","c":"poetry"}],["https://python-poetry.org/",""]]},{"t":"Str","c":". It’s like pipenv but actually good! It only takes 2 minutes to resolve dependencies instead of 10! It even puts your virtualenv in "},{"t":"Code","c":[["",[],[]],"~/.cache"]},{"t":"Str","c":" because it "},{"t":"Emph","c":[{"t":"Str","c":"really"}]},{"t":"Str","c":" doesn’t matter if it gets deleted!"}]}]]]},{"t":"Header","c":[1,["typed-argparse",[],[]],[{"t":"Str","c":"Typed Argparse"}]]},{"t":"Para","c":[{"t":"Str","c":"Argparse is a neat library to create a simple command line interface. But arguments are declared as strings, and the IDE can’t know about them."}]},{"t":"Para","c":[{"t":"Str","c":"With "},{"t":"Link","c":[["",[],[]],[{"t":"Str","c":"Typed-Argparse"}],["https://github.com/swansonk14/typed-argument-parser",""]]},{"t":"Str","c":", your arguments are parsed directly into a class instance!"}]},{"t":"Para","c":[{"t":"Image","c":[["",[],[]],[{"t":"Str","c":"TAP example"}],["https://raw.githubusercontent.com/swansonk14/typed-argument-parser/master/images/tap.png","fig:"]]}]},{"t":"CodeBlock","c":[["",[],[]],"\n```\n\n```\n\n```\n\n```\n\n```\n\n```"]}]}}},"page":"/post","query":{"slug":"2021/python-features"},"buildId":"RMhU4dOjureGSC3lY6iOI","assetPrefix":"/blog","nextExport":true,"isFallback":false,"gip":true}</script><script nomodule="" src="/blog/_next/static/chunks/polyfills-af56e6617f887d19013e.js"></script><script src="/blog/_next/static/chunks/main-a96ffcab9ac3f714966d.js" async=""></script><script src="/blog/_next/static/chunks/webpack-616848fc9016435d0c8a.js" async=""></script><script src="/blog/_next/static/chunks/framework.60867bcc68b986f6e60d.js" async=""></script><script src="/blog/_next/static/chunks/commons.08ddd7455f4143b98f8d.js" async=""></script><script src="/blog/_next/static/chunks/pages/_app-3bdda458aa4ad17304fc.js" async=""></script><script src="/blog/_next/static/chunks/06447f4e.e11bbf63b9bfcd126107.js" async=""></script><script src="/blog/_next/static/chunks/c78d26b1.84adfeb932354ef9a95e.js" async=""></script><script src="/blog/_next/static/chunks/768876d20c0ee2e540736d254e2790c53bb785f0.2a06644f067446519e2a.js" async=""></script><script src="/blog/_next/static/chunks/pages/post-4163277423727bcbd85f.js" async=""></script><script src="/blog/_next/static/RMhU4dOjureGSC3lY6iOI/_buildManifest.js" async=""></script><script src="/blog/_next/static/RMhU4dOjureGSC3lY6iOI/_ssgManifest.js" async=""></script></body></html>