<!DOCTYPE html><html><head><meta charSet="utf-8" class="next-head"/><title class="next-head">((draft)) rga: ripgrep, but also search in PDFs, E-Books, Office documents, zip, tar.gz, etc - My Blog</title><meta name="description" content="About my personal projects and other stuff" class="next-head"/><meta name="viewport" content="width=device-width, initial-scale=1" class="next-head"/><link rel="stylesheet" href="https://unpkg.com/tachyons@4.7.4/css/tachyons.min.css" class="next-head"/><style class="next-head">
          body {
            font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;
          }
      </style><link rel="preload" href="/blog/_next/static/yL36EJ7Zc_PL9inbRcs6V/pages/post.js" as="script"/><link rel="preload" href="/blog/_next/static/yL36EJ7Zc_PL9inbRcs6V/pages/_app.js" as="script"/><link rel="preload" href="/blog/_next/static/runtime/webpack-a79426b5e11f0ba5879d.js" as="script"/><link rel="preload" href="/blog/_next/static/chunks/commons.9ab08b6a0150cfb810d8.js" as="script"/><link rel="preload" href="/blog/_next/static/runtime/main-541f01c65744a5c2c60b.js" as="script"/><style id="__jsx-2084352328">.content a{color:#0365a5;-webkit-text-decoration:none;text-decoration:none;border-bottom:1px solid #dfdfdf;-webkit-transition:all 300ms ease;transition:all 300ms ease;}a:hover,a:focus{border-bottom-color:currentColor;}code{background-color:#eee;line-height:1;border-radius:2px;padding:1px;}code{border:1px solid #ddd;}pre code{border:none;}</style></head><body><div id="__next"><div class="jsx-2084352328"><div><main class="lh-copy"><div class="relative tc bg-dark-gray"><div class="mw7 center white pv4"><div class="pv4"><h1 class="f1 normal lh-title ma0 pa0"><a class="white no-underline" href="/blog">My Blog</a></h1><h4 class="normal o-70 ma0 pt2 pb3 ph1">About my personal projects and other stuff</h4><div><a class="dib f6 white no-underline pa1 ma1" href="https://github.com/phiresky/">Github</a></div></div></div></div><div class="jsx-2084352328 content center mw7 pa3 pa4-ns"><h1 class="jsx-2084352328 mt0 lh-title">((draft)) rga: ripgrep, but also search in PDFs, E-Books, Office documents, zip, tar.gz, etc</h1><p>rga is a line-oriented search tool that allows you to look for a regex in a multitude of file types. rga wraps the awesome <a href="https://github.com/BurntSushi/ripgrep">ripgrep</a> and enables it to search in pdf, docx, sqlite, jpg, movie subtitles (mkv, mp4), etc.</p><p><a href="https://travis-ci.org/phiresky/ripgrep_all"><img alt="Linux build status" src="https://api.travis-ci.org/phiresky/ripgrep_all.svg"/></a>
<a href="https://crates.io/crates/ripgrep_all"><img alt="Crates.io" src="https://img.shields.io/crates/v/ripgrep_all.svg"/></a></p><h2>Examples</h2><h3>PDFs</h3><p>Say you have a large folder of papers or lecture slides, and you can&#x27;t remember which one of them mentioned <code>LSTM</code>s. With rga, you can just run this:</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">&gt;</span> rga <span class="token" style="color:#2f9c0a">&quot;LSTM|GRU&quot;</span> collection/

<span class="token" style="color:#5F6364">[</span>results<span class="token" style="color:#5F6364">]</span></code></pre><p>and it will recursively find a regex in pdfs and pptx slides, including if some of them are zipped up.</p><p>You can do mostly the same thing with <a href="https://pdfgrep.org/"><code>pdfgrep -r</code></a>, but you will miss content in other file types and it will be much slower:</p><div><div style="text-align:center"><p>Searching in 65 pdfs with 93 slides each</p></div><div class="recharts-wrapper" style="position:relative;cursor:default;width:600px;height:200px"><svg class="recharts-surface" width="600" height="200" viewBox="0 0 600 200" version="1.1"><defs><clipPath id="recharts2-clip"><rect x="205" y="5" height="160" width="390"></rect></clipPath></defs><g class="recharts-layer recharts-cartesian-axis recharts-xAxis xAxis"><line class="recharts-cartesian-axis-line" width="390" height="30" x="205" y="165" stroke="#666" fill="none" x1="205" y1="165" x2="595" y2="165"></line><g class="recharts-cartesian-axis-ticks"><g class="recharts-layer recharts-cartesian-axis-tick"><line class="recharts-cartesian-axis-tick-line" width="390" height="30" x="205" y="165" stroke="#666" fill="none" x1="205" y1="171" x2="205" y2="165"></line><text width="390" height="30" x="205" y="173" stroke="none" fill="#666" class="recharts-text recharts-cartesian-axis-tick-value" text-anchor="middle"><tspan x="205" dy="0.71em">0</tspan></text></g><g class="recharts-layer recharts-cartesian-axis-tick"><line class="recharts-cartesian-axis-tick-line" width="390" height="30" x="205" y="165" stroke="#666" fill="none" x1="302.5" y1="171" x2="302.5" y2="165"></line><text width="390" height="30" x="302.5" y="173" stroke="none" fill="#666" class="recharts-text recharts-cartesian-axis-tick-value" text-anchor="middle"><tspan x="302.5" dy="0.71em">8</tspan></text></g><g class="recharts-layer recharts-cartesian-axis-tick"><line class="recharts-cartesian-axis-tick-line" width="390" height="30" x="205" y="165" stroke="#666" fill="none" x1="400" y1="171" x2="400" y2="165"></line><text width="390" height="30" x="400" y="173" stroke="none" fill="#666" class="recharts-text recharts-cartesian-axis-tick-value" text-anchor="middle"><tspan x="400" dy="0.71em">16</tspan></text></g><g class="recharts-layer recharts-cartesian-axis-tick"><line class="recharts-cartesian-axis-tick-line" width="390" height="30" x="205" y="165" stroke="#666" fill="none" x1="497.5" y1="171" x2="497.5" y2="165"></line><text width="390" height="30" x="497.5" y="173" stroke="none" fill="#666" class="recharts-text recharts-cartesian-axis-tick-value" text-anchor="middle"><tspan x="497.5" dy="0.71em">24</tspan></text></g><g class="recharts-layer recharts-cartesian-axis-tick"><line class="recharts-cartesian-axis-tick-line" width="390" height="30" x="205" y="165" stroke="#666" fill="none" x1="595" y1="171" x2="595" y2="165"></line><text width="390" height="30" x="595" y="173" stroke="none" fill="#666" class="recharts-text recharts-cartesian-axis-tick-value" text-anchor="middle"><tspan x="595" dy="0.71em">32</tspan></text></g></g></g><g class="recharts-layer recharts-cartesian-axis recharts-yAxis yAxis"><line class="recharts-cartesian-axis-line" width="200" height="160" x="5" y="5" stroke="#666" fill="none" x1="205" y1="5" x2="205" y2="165"></line><g class="recharts-cartesian-axis-ticks"><g class="recharts-layer recharts-cartesian-axis-tick"><line class="recharts-cartesian-axis-tick-line" width="200" height="160" x="5" y="5" stroke="#666" fill="none" x1="199" y1="31.666666666666668" x2="205" y2="31.666666666666668"></line><text width="200" height="160" x="197" y="31.666666666666668" stroke="none" fill="#666" class="recharts-text recharts-cartesian-axis-tick-value" text-anchor="end"><tspan x="197" dy="0.355em">pdfgrep</tspan></text></g><g class="recharts-layer recharts-cartesian-axis-tick"><line class="recharts-cartesian-axis-tick-line" width="200" height="160" x="5" y="5" stroke="#666" fill="none" x1="199" y1="85" x2="205" y2="85"></line><text width="200" height="160" x="197" y="85" stroke="none" fill="#666" class="recharts-text recharts-cartesian-axis-tick-value" text-anchor="end"><tspan x="197" dy="0.355em">rga (first run)</tspan></text></g><g class="recharts-layer recharts-cartesian-axis-tick"><line class="recharts-cartesian-axis-tick-line" width="200" height="160" x="5" y="5" stroke="#666" fill="none" x1="199" y1="138.33333333333334" x2="205" y2="138.33333333333334"></line><text width="200" height="160" x="197" y="138.33333333333334" stroke="none" fill="#666" class="recharts-text recharts-cartesian-axis-tick-value" text-anchor="end"><tspan x="197" dy="0.355em">rga (subsequent runs)</tspan></text></g></g></g><g class="recharts-layer recharts-bar"><g class="recharts-layer recharts-bar-rectangles"><g class="recharts-layer recharts-bar-rectangle"><path fill="#8884d8" width="377.446875" height="42" x="205" y="10.333333333333334" radius="0" class="recharts-rectangle" d="M 205,10.333333333333334 h 377.446875 v 42 h -377.446875 Z"></path></g><g class="recharts-layer recharts-bar-rectangle"><path fill="#8884d8" width="120.77812499999999" height="42" x="205" y="63.66666666666667" radius="0" class="recharts-rectangle" d="M 205,63.66666666666667 h 120.77812499999999 v 42 h -120.77812499999999 Z"></path></g><g class="recharts-layer recharts-bar-rectangle"><path fill="#8884d8" width="1.9012500000000045" height="42" x="205" y="117" radius="0" class="recharts-rectangle" d="M 205,117 h 1.9012500000000045 v 42 h -1.9012500000000045 Z"></path></g></g></g></svg><div class="recharts-legend-wrapper" style="position:absolute;width:590px;height:auto;left:5px;bottom:5px"><ul class="recharts-default-legend" style="padding:0;margin:0;text-align:center"><li class="recharts-legend-item legend-item-0" style="display:inline-block;margin-right:10px"><svg class="recharts-surface" width="14" height="14" style="display:inline-block;vertical-align:middle;margin-right:4px" viewBox="0 0 32 32" version="1.1"><path stroke="none" fill="#8884d8" d="M0,4h32v24h-32z" class="recharts-legend-icon"></path></svg><span class="recharts-legend-item-text">run time (seconds, lower is better)</span></li></ul></div><div class="recharts-tooltip-wrapper" style="pointer-events:none;visibility:hidden;position:absolute;top:0;transform:translate(undefinedpx, undefinedpx);-webkit-transform:translate(undefinedpx, undefinedpx);-moz-transform:translate(undefinedpx, undefinedpx);-o-transform:translate(undefinedpx, undefinedpx);-ms-transform:translate(undefinedpx, undefinedpx)"><div class="recharts-default-tooltip" style="margin:0;padding:10px;background-color:#fff;border:1px solid #ccc;white-space:nowrap"><p class="recharts-tooltip-label" style="margin:0"></p></div></div></div></div><p>On the first run rga is mostly faster because of multithreading, but on subsequent runs (with the same files but any regex query) rga will cache the text extraction, so it becomes almost as fast as searching in plain text files.</p><h3>Other files</h3><p>rga will recursively descend into archives and match text in every file type it knows.</p><p>Here is an example:</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">demo
├── hello.odt
├── hello.sqlite3
├── greeting.mkv
└── somearchive.zip
    ├── dir
    │   ├── greeting.docx
    │   └── inner.tar.gz
    │       └── greeting.pdf
    └── greeting.epub</code></pre><pre class="ansi2html">
$ rga &quot;hello&quot; demo/

<span style="color:#E850A8">hello.odt</span>
<span style="font-weight:bold"></span><span style="font-weight:bold;color:#aa0000">Hello</span> from an OpenDocument file!

<span style="color:#E850A8">somearchive.zip</span>
dir/greeting.docx: <span style="font-weight:bold"></span><span style="font-weight:bold;color:#aa0000">Hello</span> from a MS Office document!
dir/inner.tar.gz: greeting.pdf: Page 1: <span style="font-weight:bold"></span><span style="font-weight:bold;color:#aa0000">Hello</span> from a PDF!
greeting.epub: <span style="font-weight:bold"></span><span style="font-weight:bold;color:#aa0000">Hello</span> from an E-Book!

<span style="color:#E850A8">greeting.mkv</span>
metadata: chapters.chapter.0.tags.title=&quot;Chapter 1: <span style="font-weight:bold"></span><span style="font-weight:bold;color:#aa0000">Hello</span>&quot;
00:08.398 --&gt; 00:11.758: <span style="font-weight:bold"></span><span style="font-weight:bold;color:#aa0000">Hello</span> from a movie!

<span style="color:#E850A8">hello.sqlite3</span>
tbl: greeting=&#x27;<span style="font-weight:bold"></span><span style="font-weight:bold;color:#aa0000">hello</span>&#x27;, from=&#x27;sqlite database!&#x27;

</pre><p>It can even search jpg / png images and scanned pdfs using OCR, though this is disabled by default since it is not useful that often and very slow.</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none">rga --rga-adapters<span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">=</span>+pdfpages,tesseract hello inputdir</code></pre><h2>Setup</h2><p>rga should compile with stable Rust. To install it, simply run (your OSes equivalent of)</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#2f9c0a">apt</span> <span class="token" style="color:#2f9c0a">install</span> build-essential pandoc poppler-utils ffmpeg
cargo <span class="token" style="color:#2f9c0a">install</span> ripgrep_all

rga --help <span class="token" style="color:#7D8B99"># works! :)</span></code></pre><p>You don&#x27;t necessarily need to install any dependencies, but then you will see an error when trying to read from the corresponding file type (e.g. poppler-utils for pdf).</p><h2>Technical details</h2><p><code>rga</code> simply runs ripgrep (<code>rg</code>) with some options set, especially <code>--pre=rga-preproc</code> and <code>--pre-glob</code>.</p><p><code>rga-preproc [fname]</code> will match an &quot;adapter&quot; to the given file based on either it&#x27;s filename or it&#x27;s mime type (if <code>--accurate</code> is given). You can see all adapters currently included in <a href="src/adapters">src/adapters</a>.</p><p>Some rga adapters run external binaries to do the actual work (such as pandoc or ffmpeg), usually by writing to stdin and reading from stdout. Others use a Rust library or bindings to achieve the same effect (like sqlite or zip).</p><p>To read archives, the <code>zip</code> and <code>tar</code> libraries are used, which work fully in a streaming fashion - this means that the RAM usage is low and no data is ever actually extracted to disk!</p><p>Most adapters read the files from a <a href="https://doc.rust-lang.org/std/io/trait.Read.html">Read</a>, so they work completely on streamed data (that can come from anywhere including within nested archives).</p><p>During the extraction, rga-preproc will compress the data with ZSTD to a memory cache while simultaneously writing it uncompressed to stdout. After completion, if the memory cache is smaller than 2MByte, it is written to a <a href="https://docs.rs/rkv/0.9.6/rkv/">rkv</a> cache</p><h2>Development</h2><p>To enable debug logging:</p><pre style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;position:relative;margin:.5em 0;overflow:visible;padding:0;background-color:#fdfdfd;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin-bottom:1em"><code style="color:black;background:none;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#2f9c0a">export</span> RUST_LOG<span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">=</span>debug
<span class="token" style="color:#2f9c0a">export</span> RUST_BACKTRACE<span class="token" style="color:#a67f59;background:rgba(255, 255, 255, 0.5)">=</span>1</code></pre><p>Also rember to disable caching with <code>--rga-no-cache</code> or clear the cache in <code>~/.cache/rga</code> to debug the adapters.</p><h2>Future Work</h2><ul><li>I wanted to add a photograph adapter (based on object classification / detection) for fun, so you can grep for &quot;mountain&quot; and it will show pictures of mountains, like in Google Photos. It worked with <a href="https://pjreddie.com/darknet/yolo/">YOLO</a>, but something more useful and state-of-the art <a href="https://github.com/aimagelab/show-control-and-tell">like this</a> proved very hard to integrate.</li><li>7z adapter (couldn&#x27;t find a nice to use Rust library with streaming)</li><li>allow per-adapter configuration options (probably via env (RGA_ADAPTER_CONF=json))</li><li>maybe use a different disk kv-store as a cache instead of rkv, because I had some <a href="src/preproc_cache.rs#30">weird problems</a> with that. SQLite is great. All other Rust alternatives I could find don&#x27;t allow writing from multiple processes.</li><li>there&#x27;s some more (mostly technical) todos in the code I don&#x27;t know how to fix</li></ul><h2>Similar tools</h2><ul><li><a href="https://pdfgrep.org/">pdfgrep</a></li><li><a href="https://gist.github.com/phiresky/5025490526ba70663ab3b8af6c40a8db">this gist</a> has my proof of concept version of a caching extractor to use ripgrep as a replacement for pdfgrep.</li><li><a href="https://gist.github.com/ColonolBuendia/314826e37ec35c616d70506c38dc65aa">this gist</a> is a more extensive preprocessing script by <a href="https://github.com/ColonolBuendia">@ColonolBuendia</a></li></ul><style>
pre {
   white-space: pre-wrap;
   word-wrap: break-word;
}
.ansi2html {
   color: white;
   background-color: black;
}
</style></div><footer class="center w5 f6 tc mt4"><p><span>© </span><span>2019<!-- --> </span><span></span></p></footer></main></div></div></div><script id="__NEXT_DATA__" type="application/json">{"dataManager":"[]","props":{"pageProps":{"post":{"filename":"2019/rga--ripgrep-for-zip-targz-docx-odt-epub-jpg.md","frontmatter":{"title":"((draft)) rga: ripgrep, but also search in PDFs, E-Books, Office documents, zip, tar.gz, etc","date":"2019-06-13T00:00:00.000Z"},"preview":"rga  is  a  line-oriented  search  tool  that  allows  you  to  look  for  a  regex  in  a  multitude  of  file  types.  rga  wraps  the  awesome  ripgrep  and  enables  it  to  search  in  pdf,  docx,  sqlite,  jpg,  movie  subtitles  (mkv,  mp4),  etc.  Linux  build  status  Crates.io  Examples","content_md":"\nrga is a line-oriented search tool that allows you to look for a regex in a multitude of file types. rga wraps the awesome [ripgrep] and enables it to search in pdf, docx, sqlite, jpg, movie subtitles (mkv, mp4), etc.\n\n[![Linux build status](https://api.travis-ci.org/phiresky/ripgrep_all.svg)](https://travis-ci.org/phiresky/ripgrep_all)\n[![Crates.io](https://img.shields.io/crates/v/ripgrep_all.svg)](https://crates.io/crates/ripgrep_all)\n\n## Examples\n\n### PDFs\n\nSay you have a large folder of papers or lecture slides, and you can't remember which one of them mentioned `LSTM`s. With rga, you can just run this:\n\n```bash\n\u003e rga \"LSTM|GRU\" collection/\n\n[results]\n```\n\nand it will recursively find a regex in pdfs and pptx slides, including if some of them are zipped up.\n\nYou can do mostly the same thing with [`pdfgrep -r`][pdfgrep], but you will miss content in other file types and it will be much slower:\n\n```barchart\ntitle: Searching in 65 pdfs with 93 slides each\nseries: run time (seconds, lower is better)\ndata:\n   pdfgrep: 30.97\n   rga (first run): 9.91\n   rga (subsequent runs): 0.156\n```\n\nOn the first run rga is mostly faster because of multithreading, but on subsequent runs (with the same files but any regex query) rga will cache the text extraction, so it becomes almost as fast as searching in plain text files.\n\n### Other files\n\nrga will recursively descend into archives and match text in every file type it knows.\n\nHere is an example:\n\n```\ndemo\n├── hello.odt\n├── hello.sqlite3\n├── greeting.mkv\n└── somearchive.zip\n    ├── dir\n    │   ├── greeting.docx\n    │   └── inner.tar.gz\n    │       └── greeting.pdf\n    └── greeting.epub\n```\n\n\u003cpre class=\"ansi2html\"\u003e\n$ rga \"hello\" demo/\n\n\u003cspan style=\"color: #E850A8\"\u003ehello.odt\u003c/span\u003e\n\u003cspan style=\"font-weight: bold\"\u003e\u003c/span\u003e\u003cspan style=\"font-weight: bold; color: #aa0000\"\u003eHello\u003c/span\u003e from an OpenDocument file!\n\n\u003cspan style=\"color: #E850A8\"\u003esomearchive.zip\u003c/span\u003e\ndir/greeting.docx: \u003cspan style=\"font-weight: bold\"\u003e\u003c/span\u003e\u003cspan style=\"font-weight: bold; color: #aa0000\"\u003eHello\u003c/span\u003e from a MS Office document!\ndir/inner.tar.gz: greeting.pdf: Page 1: \u003cspan style=\"font-weight: bold\"\u003e\u003c/span\u003e\u003cspan style=\"font-weight: bold; color: #aa0000\"\u003eHello\u003c/span\u003e from a PDF!\ngreeting.epub: \u003cspan style=\"font-weight: bold\"\u003e\u003c/span\u003e\u003cspan style=\"font-weight: bold; color: #aa0000\"\u003eHello\u003c/span\u003e from an E-Book!\n\n\u003cspan style=\"color: #E850A8\"\u003egreeting.mkv\u003c/span\u003e\nmetadata: chapters.chapter.0.tags.title=\"Chapter 1: \u003cspan style=\"font-weight: bold\"\u003e\u003c/span\u003e\u003cspan style=\"font-weight: bold; color: #aa0000\"\u003eHello\u003c/span\u003e\"\n00:08.398 --\u0026gt; 00:11.758: \u003cspan style=\"font-weight: bold\"\u003e\u003c/span\u003e\u003cspan style=\"font-weight: bold; color: #aa0000\"\u003eHello\u003c/span\u003e from a movie!\n\n\u003cspan style=\"color: #E850A8\"\u003ehello.sqlite3\u003c/span\u003e\ntbl: greeting='\u003cspan style=\"font-weight: bold\"\u003e\u003c/span\u003e\u003cspan style=\"font-weight: bold; color: #aa0000\"\u003ehello\u003c/span\u003e', from='sqlite database!'\n\n\u003c/pre\u003e\n\nIt can even search jpg / png images and scanned pdfs using OCR, though this is disabled by default since it is not useful that often and very slow.\n\n```bash\nrga --rga-adapters=+pdfpages,tesseract hello inputdir\n```\n\n## Setup\n\nrga should compile with stable Rust. To install it, simply run (your OSes equivalent of)\n\n```bash\napt install build-essential pandoc poppler-utils ffmpeg\ncargo install ripgrep_all\n\nrga --help # works! :)\n```\n\nYou don't necessarily need to install any dependencies, but then you will see an error when trying to read from the corresponding file type (e.g. poppler-utils for pdf).\n\n## Technical details\n\n`rga` simply runs ripgrep (`rg`) with some options set, especially `--pre=rga-preproc` and `--pre-glob`.\n\n`rga-preproc [fname]` will match an \"adapter\" to the given file based on either it's filename or it's mime type (if `--accurate` is given). You can see all adapters currently included in [src/adapters](src/adapters).\n\nSome rga adapters run external binaries to do the actual work (such as pandoc or ffmpeg), usually by writing to stdin and reading from stdout. Others use a Rust library or bindings to achieve the same effect (like sqlite or zip).\n\nTo read archives, the `zip` and `tar` libraries are used, which work fully in a streaming fashion - this means that the RAM usage is low and no data is ever actually extracted to disk!\n\nMost adapters read the files from a [Read](https://doc.rust-lang.org/std/io/trait.Read.html), so they work completely on streamed data (that can come from anywhere including within nested archives).\n\nDuring the extraction, rga-preproc will compress the data with ZSTD to a memory cache while simultaneously writing it uncompressed to stdout. After completion, if the memory cache is smaller than 2MByte, it is written to a [rkv](https://docs.rs/rkv/0.9.6/rkv/) cache\n\n## Development\n\nTo enable debug logging:\n\n```bash\nexport RUST_LOG=debug\nexport RUST_BACKTRACE=1\n```\n\nAlso rember to disable caching with `--rga-no-cache` or clear the cache in `~/.cache/rga` to debug the adapters.\n\n## Future Work\n\n-   I wanted to add a photograph adapter (based on object classification / detection) for fun, so you can grep for \"mountain\" and it will show pictures of mountains, like in Google Photos. It worked with [YOLO](https://pjreddie.com/darknet/yolo/), but something more useful and state-of-the art [like this](https://github.com/aimagelab/show-control-and-tell) proved very hard to integrate.\n-   7z adapter (couldn't find a nice to use Rust library with streaming)\n-   allow per-adapter configuration options (probably via env (RGA_ADAPTER_CONF=json))\n-   maybe use a different disk kv-store as a cache instead of rkv, because I had some [weird problems](src/preproc_cache.rs#30) with that. SQLite is great. All other Rust alternatives I could find don't allow writing from multiple processes.\n-   there's some more (mostly technical) todos in the code I don't know how to fix\n\n## Similar tools\n\n-   [pdfgrep][pdfgrep]\n-   [this gist](https://gist.github.com/phiresky/5025490526ba70663ab3b8af6c40a8db) has my proof of concept version of a caching extractor to use ripgrep as a replacement for pdfgrep.\n-   [this gist](https://gist.github.com/ColonolBuendia/314826e37ec35c616d70506c38dc65aa) is a more extensive preprocessing script by [@ColonolBuendia](https://github.com/ColonolBuendia)\n\n[pdfgrep]: https://pdfgrep.org/\n[ripgrep]: https://github.com/BurntSushi/ripgrep\n\n\u003cstyle\u003e\npre {\n   white-space: pre-wrap;\n   word-wrap: break-word;\n}\n.ansi2html {\n   color: white;\n   background-color: black;\n}\n\u003c/style\u003e\n"}}},"page":"/post","query":{},"buildId":"yL36EJ7Zc_PL9inbRcs6V","dynamicBuildId":false,"assetPrefix":"/blog","nextExport":true}</script><script async="" id="__NEXT_PAGE__/post" src="/blog/_next/static/yL36EJ7Zc_PL9inbRcs6V/pages/post.js"></script><script async="" id="__NEXT_PAGE__/_app" src="/blog/_next/static/yL36EJ7Zc_PL9inbRcs6V/pages/_app.js"></script><script src="/blog/_next/static/runtime/webpack-a79426b5e11f0ba5879d.js" async=""></script><script src="/blog/_next/static/chunks/commons.9ab08b6a0150cfb810d8.js" async=""></script><script src="/blog/_next/static/runtime/main-541f01c65744a5c2c60b.js" async=""></script></body></html>